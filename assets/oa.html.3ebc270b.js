import{_ as n,o as s,c as a,a as t}from"./app.dad05bb1.js";const p={},o=t(`<h1 id="oa" tabindex="-1"><a class="header-anchor" href="#oa" aria-hidden="true">#</a> OA</h1><h2 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h2><h2 id="管理员工作" tabindex="-1"><a class="header-anchor" href="#管理员工作" aria-hidden="true">#</a> 管理员工作</h2><p>基础工作：</p><ol><li>组织架构管理</li><li>人员管理</li><li>系统维护</li></ol><p>二开：</p><ol><li><p>手机批量授权</p></li><li><p>流程组设置用户可见范围</p></li><li><p>考勤管理</p></li><li><p>合同管理 （公司二叉树表获取字段值)、合同编号生成规则、合同查询表、合同权限表、合同维护表</p></li><li><p>流程发起四位编号</p></li></ol><h2 id="系统升级" tabindex="-1"><a class="header-anchor" href="#系统升级" aria-hidden="true">#</a> 系统升级</h2><p>2015年 oa系统迁移从**公司迁移过来：增加费用报销模块</p><p>升级到8.0：增加企业微信</p><p>升级到8.6.7：兼容edge浏览器</p><h2 id="二开sql语句" tabindex="-1"><a class="header-anchor" href="#二开sql语句" aria-hidden="true">#</a> 二开SQL语句</h2><h3 id="手机授权s" tabindex="-1"><a class="header-anchor" href="#手机授权s" aria-hidden="true">#</a> 手机授权s</h3><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">usersid</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">mobile</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span> int
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">mobile</span></span><span class="token operator">=</span><span class="token string">&#39;mobile&#39;</span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span> <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token punctuation">)</span>
begin
<span class="token operator">--</span>select <span class="token operator">*</span> from AppUsers
<span class="token operator">--</span>select <span class="token operator">*</span> from AppUserslog 
set  <span class="token decorator"><span class="token at operator">@</span><span class="token function">usersid</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>
select top <span class="token number">1</span> a<span class="token punctuation">.</span>UserID  from Users a 
left join dbo<span class="token punctuation">.</span>UsersInfo b  on a<span class="token punctuation">.</span>UserID<span class="token operator">=</span>b<span class="token punctuation">.</span>UserID 
where a<span class="token punctuation">.</span>UserID not <span class="token keyword">in</span>  <span class="token punctuation">(</span>select userid from AppUsers<span class="token punctuation">)</span> and DeleteFlag<span class="token operator">=</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">)</span>
 <span class="token operator">--</span>设置userid值<span class="token punctuation">,</span>不在userid 中 和  DeleteFlag<span class="token operator">=</span><span class="token string">&#39;0&#39;</span>  
 <span class="token operator">--</span>dbo<span class="token punctuation">.</span>UsersInfo  deleteflag 表示用户是否删除  <span class="token number">0</span> 代表正常用户  <span class="token number">1</span> 代表已删除用户

<span class="token keyword">if</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">usersid</span></span> <span class="token keyword">is</span>  <span class="token keyword">null</span>  <span class="token keyword">break</span>   <span class="token operator">--</span>判定如果是空值终止循环
<span class="token keyword">else</span>
<span class="token constant">INSERT</span> <span class="token constant">INTO</span> dbo<span class="token punctuation">.</span><span class="token function">AppUserslog</span>  <span class="token punctuation">(</span>userid<span class="token punctuation">,</span>xieruriqi<span class="token punctuation">)</span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">usersid</span></span><span class="token punctuation">,</span><span class="token function">Convert</span><span class="token punctuation">(</span>Datetime<span class="token punctuation">,</span><span class="token function">GetDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token operator">--</span>写入log日志
<span class="token constant">INSERT</span> <span class="token constant">INTO</span>  dbo<span class="token punctuation">.</span><span class="token function">AppUsers</span> <span class="token punctuation">(</span>appname<span class="token punctuation">,</span>userid<span class="token punctuation">)</span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mobile</span></span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">usersid</span></span><span class="token punctuation">)</span> <span class="token operator">--</span>插入值
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span><span class="token operator">+</span><span class="token number">1</span>  
end
</code></pre></div><h3 id="用户数量大于95-自动执行" tabindex="-1"><a class="header-anchor" href="#用户数量大于95-自动执行" aria-hidden="true">#</a> 用户数量大于95 自动执行</h3><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">yonghu</span></span> int

set  <span class="token decorator"><span class="token at operator">@</span><span class="token function">yonghu</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select <span class="token constant">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> from  users where LonginStatus<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>

Update   users <span class="token keyword">set</span> LonginStatus<span class="token operator">=</span><span class="token number">0</span> where LonginStatus<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token number">0</span> and <span class="token decorator"><span class="token at operator">@</span><span class="token function">yonghu</span></span> <span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token number">95</span>
</code></pre></div><h3 id="日志清除" tabindex="-1"><a class="header-anchor" href="#日志清除" aria-hidden="true">#</a> 日志清除</h3><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code><span class="token constant">USE</span> <span class="token punctuation">[</span>master<span class="token punctuation">]</span>
 <span class="token constant">GO</span>
<span class="token constant">ALTER</span> <span class="token constant">DATABASE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span> 
<span class="token constant">SET</span> <span class="token constant">RECOVERY</span> <span class="token constant">SIMPLE</span> <span class="token constant">WITH</span> <span class="token constant">NO_WAIT</span>
<span class="token constant">GO</span>
<span class="token constant">ALTER</span> <span class="token constant">DATABASE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span> 
<span class="token constant">SET</span> <span class="token constant">RECOVERY</span> <span class="token constant">SIMPLE</span>
<span class="token constant">GO</span>
<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token constant">DBCC</span> <span class="token constant">SHRINKFILE</span> <span class="token punctuation">(</span><span class="token constant">N</span><span class="token string">&#39;C6_log&#39;</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">TRUNCATEONLY</span><span class="token punctuation">)</span>
<span class="token constant">GO</span>
 <span class="token constant">USE</span> <span class="token punctuation">[</span>master<span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token constant">ALTER</span> <span class="token constant">DATABASE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span> 
<span class="token constant">SET</span> <span class="token constant">RECOVERY</span> <span class="token constant">FULL</span> <span class="token constant">WITH</span> <span class="token constant">NO_WAIT</span>
<span class="token constant">GO</span>
<span class="token constant">ALTER</span> <span class="token constant">DATABASE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span> 
<span class="token constant">SET</span> <span class="token constant">RECOVERY</span> <span class="token constant">FULL</span>
 <span class="token constant">GO</span>
</code></pre></div><h3 id="考勤模块" tabindex="-1"><a class="header-anchor" href="#考勤模块" aria-hidden="true">#</a> 考勤模块</h3><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>exec 菜单_考勤授权

<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[菜单_考勤授权]    Script Date: 2022/11/14 10:07:04 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
	<span class="token constant">ALTER</span> <span class="token constant">PROCEDURE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>菜单_考勤授权<span class="token punctuation">]</span> <span class="token keyword">as</span>
	
	<span class="token operator">--</span>考勤授权
	<span class="token operator">--</span>用户授权 <span class="token number">2020</span>年<span class="token number">11</span>月<span class="token number">5</span>日
	<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">userid</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span> int

set <span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span> <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token punctuation">)</span>
begin

	set <span class="token decorator"><span class="token at operator">@</span><span class="token function">userid</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select  top <span class="token number">1</span> UserID from vw_Users  where DeleteFlag<span class="token operator">=</span><span class="token number">0</span> and userid not <span class="token keyword">in</span><span class="token punctuation">(</span> select <span class="token constant">DISTINCT</span> ObjectValue from Role2Object<span class="token punctuation">)</span> <span class="token punctuation">)</span>
	<span class="token operator">--</span>人员插入


	<span class="token keyword">if</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">userid</span></span> <span class="token keyword">is</span>  <span class="token keyword">null</span>  <span class="token keyword">break</span>   <span class="token operator">--</span>判定如果是空值终止循环
    <span class="token keyword">else</span>
	insert into Role2Object  <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token number">1421</span><span class="token punctuation">,</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">userid</span></span><span class="token punctuation">)</span>
	set <span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">num</span></span><span class="token operator">+</span><span class="token number">1</span>  
end

</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>exec 年假_年假
<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[年假_年假]    Script Date: 2022/11/14 10:07:26 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">ALTER</span> proc <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>年假_年假<span class="token punctuation">]</span> <span class="token keyword">as</span>
update ygqingjiadan_zibiao  <span class="token keyword">set</span> gonghao<span class="token operator">=</span>a<span class="token punctuation">.</span>gonghao from ygqingjiadan a inner join ygqingjiadan_zibiao b on a<span class="token punctuation">.</span>mainid<span class="token operator">=</span>b<span class="token punctuation">.</span>mainid and b<span class="token punctuation">.</span>是否同步<span class="token operator">=</span><span class="token number">0</span>
update ygqingjiadan_zibiao  <span class="token keyword">set</span> xingming<span class="token operator">=</span>a<span class="token punctuation">.</span>xingming from ygqingjiadan a inner join ygqingjiadan_zibiao b on a<span class="token punctuation">.</span>mainid<span class="token operator">=</span>b<span class="token punctuation">.</span>mainid and b<span class="token punctuation">.</span>是否同步<span class="token operator">=</span><span class="token number">0</span>

<span class="token keyword">declare</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">xingming</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span> float<span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">是否同步</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>

<span class="token constant">DECLARE</span> cur <span class="token constant">CURSOR</span> <span class="token constant">STATIC</span> <span class="token keyword">for</span>				<span class="token operator">--</span>声明静态游标
 <span class="token constant">SELECT</span>  gonghao<span class="token punctuation">,</span>mainid<span class="token punctuation">,</span>minute<span class="token punctuation">,</span>是否同步<span class="token punctuation">,</span>start_time  <span class="token constant">FROM</span>   ygqingjiadan_zibiao <span class="token constant">A</span> <span class="token constant">INNER</span> <span class="token constant">JOIN</span> ModuleApproveFlag <span class="token constant">AS</span> <span class="token constant">C</span> <span class="token constant">ON</span> <span class="token constant">A</span><span class="token punctuation">.</span>mainid <span class="token operator">=</span> <span class="token constant">C</span><span class="token punctuation">.</span><span class="token constant">ID</span> <span class="token constant">AND</span> <span class="token constant">C</span><span class="token punctuation">.</span>App_Flag <span class="token operator">=</span> <span class="token number">1</span> <span class="token constant">AND</span> <span class="token constant">C</span><span class="token punctuation">.</span>DelFlag <span class="token operator">&lt;</span><span class="token operator">&gt;</span> <span class="token number">1</span> 
 where   是否同步<span class="token operator">=</span><span class="token number">0</span> and ApplyLeaveType<span class="token operator">=</span><span class="token string">&#39;年假&#39;</span>
<span class="token constant">OPEN</span> cur								<span class="token operator">--</span>打开游标
<span class="token constant">FETCH</span> next <span class="token constant">FROM</span> cur <span class="token constant">INTO</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">是否同步</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span>   <span class="token operator">--</span>取数据
<span class="token constant">WHILE</span> <span class="token punctuation">(</span> @<span class="token decorator"><span class="token at operator">@</span><span class="token function">fetch_status</span></span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">)</span> 
 <span class="token constant">BEGIN</span>

 <span class="token operator">--</span>select <span class="token operator">*</span> from qidiqingjienengyuannianjia 
 <span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">ssickleave</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ysickleave</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span> float
 select <span class="token decorator"><span class="token at operator">@</span><span class="token function">ysickleave</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select yholidays   from  qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">)</span>
 select <span class="token decorator"><span class="token at operator">@</span><span class="token function">ssickleave</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select sholidays  from  qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">)</span>
  select <span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select kholidays   from  qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">)</span>
  <span class="token operator">--</span>如果pd 当前申请<span class="token operator">+</span>已申请         当前申请大于已申请 <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span><span class="token operator">=</span>   <span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span> 一共可修天数 其他输出pd
 set <span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ysickleave</span></span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span>
 <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span><span class="token operator">&gt;</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ssickleave</span></span><span class="token punctuation">)</span> begin set <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span> end
                <span class="token keyword">else</span>   begin set <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span>  end

update qidiqingjienengyuannianjia <span class="token keyword">set</span>  yholidays<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span> where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span> and year<span class="token operator">=</span><span class="token constant">DATENAME</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span><span class="token constant">GETDATE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
update ygqingjiadan_zibiao   <span class="token keyword">set</span> 是否同步<span class="token operator">=</span><span class="token number">1</span>   where gonghao<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span>  and start_time<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span> and mainid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span>


	   <span class="token constant">FETCH</span> <span class="token constant">NEXT</span>   <span class="token constant">FROM</span> cur into <span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">是否同步</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span>     <span class="token operator">--</span>游标移到下一个记录
			   <span class="token constant">END</span>
		 <span class="token constant">CLOSE</span> cur        <span class="token operator">--</span>关闭游标
		 <span class="token constant">DEALLOCATE</span> cur       <span class="token operator">--</span>释放游标

</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>exec 年假_病假
<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[年假_病假]    Script Date: 2022/11/14 10:07:54 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">ALTER</span> proc <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>年假_病假<span class="token punctuation">]</span> <span class="token keyword">as</span>
update ygqingjiadan_zibiao  <span class="token keyword">set</span> gonghao<span class="token operator">=</span>a<span class="token punctuation">.</span>gonghao from ygqingjiadan a inner join ygqingjiadan_zibiao b on a<span class="token punctuation">.</span>mainid<span class="token operator">=</span>b<span class="token punctuation">.</span>mainid and b<span class="token punctuation">.</span>是否同步<span class="token operator">=</span><span class="token number">0</span>
update ygqingjiadan_zibiao  <span class="token keyword">set</span> xingming<span class="token operator">=</span>a<span class="token punctuation">.</span>xingming from ygqingjiadan a inner join ygqingjiadan_zibiao b on a<span class="token punctuation">.</span>mainid<span class="token operator">=</span>b<span class="token punctuation">.</span>mainid and b<span class="token punctuation">.</span>是否同步<span class="token operator">=</span><span class="token number">0</span>

<span class="token keyword">declare</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">xingming</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span> float<span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">是否同步</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>

<span class="token constant">DECLARE</span> cur <span class="token constant">CURSOR</span> <span class="token constant">STATIC</span> <span class="token keyword">for</span>				<span class="token operator">--</span>声明静态游标
 <span class="token constant">SELECT</span>  gonghao<span class="token punctuation">,</span>mainid<span class="token punctuation">,</span>minute<span class="token punctuation">,</span>是否同步<span class="token punctuation">,</span>start_time  <span class="token constant">FROM</span>   ygqingjiadan_zibiao <span class="token constant">A</span> <span class="token constant">INNER</span> <span class="token constant">JOIN</span> ModuleApproveFlag <span class="token constant">AS</span> <span class="token constant">C</span> <span class="token constant">ON</span> <span class="token constant">A</span><span class="token punctuation">.</span>mainid <span class="token operator">=</span> <span class="token constant">C</span><span class="token punctuation">.</span><span class="token constant">ID</span> <span class="token constant">AND</span> <span class="token constant">C</span><span class="token punctuation">.</span>App_Flag <span class="token operator">=</span> <span class="token number">1</span> <span class="token constant">AND</span> <span class="token constant">C</span><span class="token punctuation">.</span>DelFlag <span class="token operator">&lt;</span><span class="token operator">&gt;</span> <span class="token number">1</span> 
 where   是否同步<span class="token operator">=</span><span class="token number">0</span> and ApplyLeaveType<span class="token operator">=</span><span class="token string">&#39;病假&#39;</span> and  start_time<span class="token operator">&gt;</span><span class="token string">&#39;2022-01-01&#39;</span>
<span class="token constant">OPEN</span> cur								<span class="token operator">--</span>打开游标
<span class="token constant">FETCH</span> next <span class="token constant">FROM</span> cur <span class="token constant">INTO</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">是否同步</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span>   <span class="token operator">--</span>取数据
<span class="token constant">WHILE</span> <span class="token punctuation">(</span> @<span class="token decorator"><span class="token at operator">@</span><span class="token function">fetch_status</span></span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">)</span> 
 <span class="token constant">BEGIN</span>
 <span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">ssickleave</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ysickleave</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span> float
 select <span class="token decorator"><span class="token at operator">@</span><span class="token function">ysickleave</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select ysickleave  from  qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">)</span>
 select <span class="token decorator"><span class="token at operator">@</span><span class="token function">ssickleave</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select ssickleave  from  qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">)</span>
  select <span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select ksickleave  from  qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">)</span>
  <span class="token operator">--</span>如果pd 当前申请<span class="token operator">+</span>已申请         当前申请大于已申请 <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span><span class="token operator">=</span>   <span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span> 一共可修天数 其他输出pd
 set <span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ysickleave</span></span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span>
 <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span><span class="token operator">&gt;</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ssickleave</span></span><span class="token punctuation">)</span> begin set <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span> end
                <span class="token keyword">else</span>   begin set <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span>  end

update qidiqingjienengyuannianjia <span class="token keyword">set</span> ysickleave<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span> where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span> and year<span class="token operator">=</span><span class="token constant">DATENAME</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span><span class="token constant">GETDATE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">--</span>print <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span>
<span class="token operator">--</span><span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">cs</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
<span class="token operator">--</span>select <span class="token decorator"><span class="token at operator">@</span><span class="token function">cs</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select ssickleave  from qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span>  and year<span class="token operator">=</span><span class="token constant">DATENAME</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span><span class="token constant">GETDATE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">--</span>print <span class="token decorator"><span class="token at operator">@</span><span class="token function">cs</span></span>
update ygqingjiadan_zibiao   <span class="token keyword">set</span> 是否同步<span class="token operator">=</span><span class="token number">1</span>   where gonghao<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span>  and start_time<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span> and mainid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span>


	   <span class="token constant">FETCH</span> <span class="token constant">NEXT</span>   <span class="token constant">FROM</span> cur into <span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">是否同步</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span>     <span class="token operator">--</span>游标移到下一个记录
			   <span class="token constant">END</span>
		 <span class="token constant">CLOSE</span> cur        <span class="token operator">--</span>关闭游标
		 <span class="token constant">DEALLOCATE</span> cur       <span class="token operator">--</span>释放游标





</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>exec 考勤排班创建
<span class="token constant">USE</span> <span class="token punctuation">[</span>MiddleData<span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[考勤排班创建]    Script Date: 2022/11/14 10:08:33 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">ALTER</span> proc <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>考勤排班创建<span class="token punctuation">]</span>
<span class="token keyword">as</span>



<span class="token operator">--</span>清空排版

create table #<span class="token constant">LH</span> <span class="token punctuation">(</span>d datetime<span class="token punctuation">)</span>
<span class="token operator">--</span>插入当前日期到<span class="token number">2021</span>年底
<span class="token constant">INSERT</span> into  #<span class="token constant">LH</span>
select <span class="token function">dateadd</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token builtin">number</span><span class="token punctuation">,</span><span class="token function">stuff</span><span class="token punctuation">(</span><span class="token function">convert</span><span class="token punctuation">(</span>varchar<span class="token punctuation">,</span><span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token string">&#39;d&#39;</span>
  from master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>spt_values
  where type<span class="token operator">=</span><span class="token string">&#39;P&#39;</span> and  <span class="token function">dateadd</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token builtin">number</span><span class="token punctuation">,</span><span class="token function">stuff</span><span class="token punctuation">(</span><span class="token function">convert</span><span class="token punctuation">(</span>varchar<span class="token punctuation">,</span><span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">200</span>
 <span class="token operator">--</span>select <span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">30</span>
  <span class="token operator">--</span>创建排版表

<span class="token operator">--</span>create table  <span class="token function">paiban</span> <span class="token punctuation">(</span>d datetime<span class="token punctuation">,</span>w <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">--</span>清空排版表
<span class="token keyword">delete</span> from paiban
<span class="token operator">--</span>插件到排版表 星期or上班
<span class="token constant">INSERT</span> into  paiban
select  <span class="token function">convert</span><span class="token punctuation">(</span><span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>d<span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span> <span class="token string">&#39;d&#39;</span><span class="token punctuation">,</span>
       <span class="token keyword">case</span> <span class="token function">datepart</span><span class="token punctuation">(</span>dw<span class="token punctuation">,</span>d<span class="token punctuation">)</span> when <span class="token number">1</span> then <span class="token string">&#39;星期日&#39;</span>
                           when <span class="token number">2</span> then <span class="token string">&#39;星期一&#39;</span>
                           when <span class="token number">3</span> then <span class="token string">&#39;星期二&#39;</span>
                           when <span class="token number">4</span> then <span class="token string">&#39;星期三&#39;</span>
                           when <span class="token number">5</span> then <span class="token string">&#39;星期四&#39;</span>
                           when <span class="token number">6</span> then <span class="token string">&#39;星期五&#39;</span>
                           when <span class="token number">7</span> then <span class="token string">&#39;星期六&#39;</span> end <span class="token string">&#39;w&#39;</span><span class="token punctuation">,</span>
       <span class="token keyword">case</span> when <span class="token function">datepart</span><span class="token punctuation">(</span>dw<span class="token punctuation">,</span>d<span class="token punctuation">)</span> <span class="token keyword">in</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> then <span class="token string">&#39;休息&#39;</span>
            when <span class="token function">datepart</span><span class="token punctuation">(</span>dw<span class="token punctuation">,</span>d<span class="token punctuation">)</span> <span class="token keyword">in</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span> then <span class="token string">&#39;上班&#39;</span> end <span class="token string">&#39;x&#39;</span>

from #<span class="token constant">LH</span>


<span class="token operator">--</span>select <span class="token operator">*</span> from #<span class="token constant">LH</span>
drop table #<span class="token constant">LH</span>

</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>exec 年假_历史年假
<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[年假_历史年假]    Script Date: 2022/11/14 10:08:55 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">ALTER</span> proc <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>年假_历史年假<span class="token punctuation">]</span> <span class="token keyword">as</span>
update ygqingjiadan_zibiao  <span class="token keyword">set</span> gonghao<span class="token operator">=</span>a<span class="token punctuation">.</span>gonghao from ygqingjiadan a inner join ygqingjiadan_zibiao b on a<span class="token punctuation">.</span>mainid<span class="token operator">=</span>b<span class="token punctuation">.</span>mainid and b<span class="token punctuation">.</span>是否同步<span class="token operator">=</span><span class="token number">0</span>
update ygqingjiadan_zibiao  <span class="token keyword">set</span> xingming<span class="token operator">=</span>a<span class="token punctuation">.</span>xingming from ygqingjiadan a inner join ygqingjiadan_zibiao b on a<span class="token punctuation">.</span>mainid<span class="token operator">=</span>b<span class="token punctuation">.</span>mainid and b<span class="token punctuation">.</span>是否同步<span class="token operator">=</span><span class="token number">0</span>

<span class="token keyword">declare</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">xingming</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span> float<span class="token punctuation">,</span>
		 <span class="token decorator"><span class="token at operator">@</span><span class="token function">是否同步</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
<span class="token constant">DECLARE</span> cur <span class="token constant">CURSOR</span> <span class="token constant">STATIC</span> <span class="token keyword">for</span>				<span class="token operator">--</span>声明静态游标
 <span class="token constant">SELECT</span>  gonghao<span class="token punctuation">,</span>mainid<span class="token punctuation">,</span>minute<span class="token punctuation">,</span>是否同步<span class="token punctuation">,</span>start_time  <span class="token constant">FROM</span>   ygqingjiadan_zibiao <span class="token constant">A</span> <span class="token constant">INNER</span> <span class="token constant">JOIN</span> ModuleApproveFlag <span class="token constant">AS</span> <span class="token constant">C</span> <span class="token constant">ON</span> <span class="token constant">A</span><span class="token punctuation">.</span>mainid <span class="token operator">=</span> <span class="token constant">C</span><span class="token punctuation">.</span><span class="token constant">ID</span> <span class="token constant">AND</span> <span class="token constant">C</span><span class="token punctuation">.</span>App_Flag <span class="token operator">=</span> <span class="token number">1</span> <span class="token constant">AND</span> <span class="token constant">C</span><span class="token punctuation">.</span>DelFlag <span class="token operator">&lt;</span><span class="token operator">&gt;</span> <span class="token number">1</span> 
 where   是否同步<span class="token operator">=</span><span class="token number">0</span> and ApplyLeaveType<span class="token operator">=</span><span class="token string">&#39;历史年假&#39;</span> and  start_time<span class="token operator">&gt;</span><span class="token string">&#39;2022-01-01&#39;</span>
<span class="token constant">OPEN</span> cur								<span class="token operator">--</span>打开游标
<span class="token constant">FETCH</span> next <span class="token constant">FROM</span> cur <span class="token constant">INTO</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">是否同步</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span>   <span class="token operator">--</span>取数据
<span class="token constant">WHILE</span> <span class="token punctuation">(</span> @<span class="token decorator"><span class="token at operator">@</span><span class="token function">fetch_status</span></span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">)</span> 
 <span class="token constant">BEGIN</span>
 <span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">ssickleave</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ysickleave</span></span> float<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span> float
 select <span class="token decorator"><span class="token at operator">@</span><span class="token function">ysickleave</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select ysickleave  from  qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token function">已休带薪病假</span><span class="token punctuation">(</span>天<span class="token punctuation">)</span>

 select <span class="token decorator"><span class="token at operator">@</span><span class="token function">ssickleave</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select ssickleave  from  qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token function">剩余带薪病假</span><span class="token punctuation">(</span>天<span class="token punctuation">)</span>

  select <span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select lishiyixiuholidays  from  qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">)</span>  <span class="token operator">--</span><span class="token function">历史已休年假</span><span class="token punctuation">(</span>天<span class="token punctuation">)</span>
  <span class="token operator">--</span>如果pd 当前申请<span class="token operator">+</span>已申请         当前申请大于已申请 <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span><span class="token operator">=</span>   <span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span> 一共可修天数 其他输出pd
 set <span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ysickleave</span></span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span>
 <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span><span class="token operator">&gt;</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ssickleave</span></span><span class="token punctuation">)</span> begin set <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">ksickleave</span></span> end
                <span class="token keyword">else</span>   begin set <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span>  end

update qidiqingjienengyuannianjia <span class="token keyword">set</span> lishiyixiuholidays<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">pd</span></span> where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span> and year<span class="token operator">=</span><span class="token constant">DATENAME</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span><span class="token constant">GETDATE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">--</span>print <span class="token decorator"><span class="token at operator">@</span><span class="token function">zhi</span></span>
<span class="token operator">--</span><span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">cs</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
<span class="token operator">--</span>select <span class="token decorator"><span class="token at operator">@</span><span class="token function">cs</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select ssickleave  from qidiqingjienengyuannianjia where employeeid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span>  and year<span class="token operator">=</span><span class="token constant">DATENAME</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span><span class="token constant">GETDATE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">--</span>print <span class="token decorator"><span class="token at operator">@</span><span class="token function">cs</span></span>
update ygqingjiadan_zibiao   <span class="token keyword">set</span> 是否同步<span class="token operator">=</span><span class="token number">1</span>   where gonghao<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span>  and start_time<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span> and mainid<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span>


	   <span class="token constant">FETCH</span> <span class="token constant">NEXT</span>   <span class="token constant">FROM</span> cur into <span class="token decorator"><span class="token at operator">@</span><span class="token function">gonghao</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">minute</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">是否同步</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">start_time</span></span>     <span class="token operator">--</span>游标移到下一个记录
			   <span class="token constant">END</span>
		 <span class="token constant">CLOSE</span> cur        <span class="token operator">--</span>关闭游标
		 <span class="token constant">DEALLOCATE</span> cur       <span class="token operator">--</span>释放游标





</code></pre></div><h3 id="流程组" tabindex="-1"><a class="header-anchor" href="#流程组" aria-hidden="true">#</a> 流程组</h3><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>exec 流程租

<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[流程租]    Script Date: 2022/11/14 10:09:39 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>

<span class="token constant">ALTER</span> proc <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>流程租<span class="token punctuation">]</span> <span class="token keyword">as</span>
<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>  <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span>  int <span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">userid</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>



<span class="token operator">--</span>创建 流程组_部门 表单
<span class="token keyword">if</span> <span class="token function">object_id</span><span class="token punctuation">(</span><span class="token string">&#39;c6..流程组_部门&#39;</span><span class="token punctuation">)</span> <span class="token keyword">is</span>  <span class="token keyword">null</span>  
Begin  
     <span class="token constant">CREATE</span> <span class="token constant">TABLE</span> <span class="token function">流程组_部门</span>   <span class="token punctuation">(</span>id int<span class="token punctuation">,</span>DeptName  <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     insert into  流程组_部门 <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;启迪清洁能源&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;瑞行集团&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;华业阳光&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;山东华业&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;战略协同中心&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;启迪简石&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;启迪森诺&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;启迪创新&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;启迪清风&#39;</span><span class="token punctuation">)</span>
End
<span class="token operator">--</span>drop <span class="token constant">TABLE</span> 流程组_部门
<span class="token operator">--</span>创建临时表并插入数值

<span class="token operator">--</span> select <span class="token operator">*</span> from #dept
<span class="token constant">DECLARE</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">name</span></span> <span class="token constant">NVARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>    <span class="token operator">--</span>声明变量，需要读取的数据
<span class="token constant">DECLARE</span> cur <span class="token constant">CURSOR</span> <span class="token constant">STATIC</span>				<span class="token operator">--</span>声明静态游标
<span class="token constant">FOR</span>
    <span class="token constant">SELECT</span>  DeptName  <span class="token constant">FROM</span>    流程组_部门
<span class="token constant">OPEN</span> cur								<span class="token operator">--</span>打开游标
<span class="token constant">FETCH</span> next <span class="token constant">FROM</span> cur <span class="token constant">INTO</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>    <span class="token operator">--</span>取数据
<span class="token constant">WHILE</span> <span class="token punctuation">(</span> @<span class="token decorator"><span class="token at operator">@</span><span class="token function">fetch_status</span></span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">)</span> 
<span class="token constant">BEGIN</span>
<span class="token operator">--</span> 设置需要的部门名称
<span class="token operator">--</span>select top <span class="token number">1</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span><span class="token operator">=</span>DeptName from  流程组_部门
<span class="token operator">--</span>update 流程组_部门 <span class="token keyword">set</span> id<span class="token operator">=</span><span class="token number">1</span>  where DeptName<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>
<span class="token operator">--</span>print <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>

select  <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span><span class="token operator">=</span>DeptID from Department  where DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> and  DeptName<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>
<span class="token operator">--</span>如果临时表存在删除
<span class="token keyword">if</span> <span class="token function">object_id</span><span class="token punctuation">(</span><span class="token string">&#39;tempdb..#renyuan &#39;</span><span class="token punctuation">)</span> <span class="token keyword">is</span> not <span class="token keyword">null</span>  
Begin  
       <span class="token constant">DROP</span> <span class="token constant">TABLE</span>  #renyuan  
End

<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> <span class="token function">#renyuan</span>  <span class="token punctuation">(</span>userid <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">--</span>临时表赋值
insert into #renyuan 
select userid  from RelationshipUsers where  DeptID <span class="token keyword">in</span> <span class="token punctuation">(</span>
select DeptID from Department  where DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> and  DeptName<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>
<span class="token constant">UNION</span> <span class="token constant">ALL</span>
select DeptID from Department  where DeptParentID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span>
<span class="token constant">UNION</span> <span class="token constant">ALL</span>
select DeptID  from Department  where DeptParentID <span class="token keyword">in</span> <span class="token punctuation">(</span>select DeptID from Department  where DeptParentID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span> and DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">)</span> and DeptDelFlag<span class="token operator">=</span><span class="token number">0</span>
<span class="token constant">UNION</span> <span class="token constant">ALL</span>

select  DeptID  from Department  where DeptParentID <span class="token keyword">in</span> 
<span class="token punctuation">(</span>select DeptID  from Department  where DeptParentID <span class="token keyword">in</span> 
<span class="token punctuation">(</span>select DeptID  from Department  where DeptParentID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span> and DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token constant">SELECT</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">userid</span></span><span class="token operator">=</span><span class="token constant">STUFF</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">SELECT</span>  <span class="token operator">+</span> userid <span class="token operator">+</span> <span class="token string">&#39;,&#39;</span> <span class="token constant">FROM</span> <span class="token punctuation">(</span>select <span class="token operator">*</span> from #renyuan where userid<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token string">&#39;liuhaipan&#39;</span> <span class="token punctuation">)</span> a  <span class="token constant">FOR</span>  <span class="token constant">XML</span> <span class="token constant">PATH</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>

<span class="token operator">--</span>select <span class="token operator">*</span> from #renyuan
<span class="token operator">--</span>每行尾部，添加管理员
set  <span class="token decorator"><span class="token at operator">@</span><span class="token function">userid</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">userid</span></span><span class="token operator">+</span><span class="token string">&#39;yg00023&#39;</span> 

update Filter <span class="token keyword">set</span> FilterContent<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">userid</span></span> where  FilterTitle<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>
<span class="token constant">FETCH</span> next <span class="token constant">FROM</span> cur <span class="token constant">INTO</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>

drop <span class="token constant">TABLE</span> #renyuan
end


<span class="token constant">CLOSE</span> cur								<span class="token operator">--</span>关闭游标
<span class="token constant">DEALLOCATE</span> cur
</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>exec 员工同步到考勤
<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[员工同步到考勤]    Script Date: 2022/11/14 10:10:05 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>


<span class="token constant">ALTER</span> proc  <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>员工同步到考勤<span class="token punctuation">]</span> <span class="token keyword">as</span>

<span class="token operator">--</span>创建临时表 为了公司归属查询
<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

set <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span><span class="token operator">=</span><span class="token string">&#39;启迪清洁能源&#39;</span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span><span class="token operator">=</span><span class="token string">&#39;1722&#39;</span>

<span class="token keyword">if</span> <span class="token function">object_id</span><span class="token punctuation">(</span><span class="token string">&#39;tempdb..#kaoqinqintongbulinshi &#39;</span><span class="token punctuation">)</span> <span class="token keyword">is</span> not <span class="token keyword">null</span>  
Begin  
       <span class="token constant">DROP</span> <span class="token constant">TABLE</span>  #kaoqinqintongbulinshi 
End

<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> <span class="token function">#kaoqinqintongbulinshi</span>  <span class="token punctuation">(</span>userid <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>gs <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

insert into #kaoqinqintongbulinshi 
select userid<span class="token punctuation">,</span><span class="token string">&#39;启迪清能&#39;</span>  from RelationshipUsers where  DeptID <span class="token keyword">in</span> <span class="token punctuation">(</span>
select DeptID from Department  where DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> and  DeptName<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>
<span class="token constant">UNION</span> <span class="token constant">ALL</span>
select DeptID from Department  where DeptParentID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span>
<span class="token constant">UNION</span> <span class="token constant">ALL</span>
select DeptID  from Department  where DeptParentID <span class="token keyword">in</span> <span class="token punctuation">(</span>select DeptID from Department  where DeptParentID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span> and DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">)</span> and DeptDelFlag<span class="token operator">=</span><span class="token number">0</span>
<span class="token constant">UNION</span> <span class="token constant">ALL</span>

select  DeptID  from Department  where DeptParentID <span class="token keyword">in</span> 
<span class="token punctuation">(</span>select DeptID  from Department  where DeptParentID <span class="token keyword">in</span> 
<span class="token punctuation">(</span>select DeptID  from Department  where DeptParentID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span> and DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token operator">--</span>select <span class="token operator">*</span> from Department 


set <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span><span class="token operator">=</span><span class="token string">&#39;华业阳光&#39;</span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span><span class="token operator">=</span><span class="token string">&#39;1904&#39;</span>

insert into #kaoqinqintongbulinshi 
select userid<span class="token punctuation">,</span><span class="token string">&#39;华业阳光&#39;</span>  from RelationshipUsers where  DeptID <span class="token keyword">in</span> <span class="token punctuation">(</span>
select DeptID from Department  where DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> and  DeptName<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptName</span></span>
<span class="token constant">UNION</span> <span class="token constant">ALL</span>
select DeptID from Department  where DeptParentID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span>
<span class="token constant">UNION</span> <span class="token constant">ALL</span>
select DeptID  from Department  where DeptParentID <span class="token keyword">in</span> <span class="token punctuation">(</span>select DeptID from Department  where DeptParentID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span> and DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">)</span> and DeptDelFlag<span class="token operator">=</span><span class="token number">0</span>
<span class="token constant">UNION</span> <span class="token constant">ALL</span>

select  DeptID  from Department  where DeptParentID <span class="token keyword">in</span> 
<span class="token punctuation">(</span>select DeptID  from Department  where DeptParentID <span class="token keyword">in</span> 
<span class="token punctuation">(</span>select DeptID  from Department  where DeptParentID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">DeptID</span></span> and DeptDelFlag<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>








<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">employeename</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">--</span>工号
<span class="token decorator"><span class="token at operator">@</span><span class="token function">employeeid</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">--</span>是否考勤
<span class="token decorator"><span class="token at operator">@</span><span class="token function">kq</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token operator">--</span>mainid
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MainID</span></span>  <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">--</span>公司
<span class="token decorator"><span class="token at operator">@</span><span class="token function">gs</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token operator">--</span>获取userID
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UserID</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment">/*
select * from RelationshipUsers
select * from vw_Users where UserName in(&#39;武涛&#39;,&#39;马保山&#39;)
vw_
*/</span>



<span class="token operator">--</span>设置一次最多插入<span class="token number">10</span>个员工
<span class="token comment">/*
DECLARE @i int
set @i=0

WHILE @i&lt;10 and @UserID&lt;&gt;&#39;&#39; 
BEGIN
*/</span>
<span class="token operator">--</span>select <span class="token operator">*</span> from users where UserName <span class="token keyword">in</span><span class="token punctuation">(</span> <span class="token string">&#39;王亮&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;马保山&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;徐银鸿&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;王海燕&#39;</span><span class="token punctuation">)</span>
<span class="token operator">--</span>select <span class="token operator">*</span> from vw_Users where UserName <span class="token keyword">in</span><span class="token punctuation">(</span> <span class="token string">&#39;王亮&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;马保山&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;徐银鸿&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;王海燕&#39;</span><span class="token punctuation">)</span>
<span class="token operator">--</span>select <span class="token operator">*</span> from UsersInfo where userid <span class="token operator">=</span><span class="token string">&#39;yg00023&#39;</span>
<span class="token operator">--</span>select <span class="token operator">*</span> from users where userid<span class="token operator">=</span><span class="token string">&#39;150007&#39;</span>


<span class="token operator">--</span>select <span class="token operator">*</span> from users where userID<span class="token operator">=</span><span class="token string">&#39;12754&#39;</span>
<span class="token operator">--</span>update  users <span class="token keyword">set</span> kq<span class="token operator">=</span><span class="token number">0</span>  where UserName like <span class="token string">&#39;徐银鸿&#39;</span>
<span class="token operator">--</span>select <span class="token operator">*</span> from users where UserName like <span class="token string">&#39;马保山&#39;</span>
<span class="token operator">--</span><span class="token number">2022</span>年<span class="token number">5</span>月<span class="token number">31</span>日 添加删除的员工不同步信息 UsersInfo DeleteFlag<span class="token operator">=</span><span class="token number">1</span>   select userID from UsersInfo where DeleteFlag<span class="token operator">=</span><span class="token number">1</span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">UserID</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select top <span class="token number">1</span> UserID  from Users  where kq<span class="token operator">=</span><span class="token number">1</span> and gh  not <span class="token keyword">in</span> <span class="token punctuation">(</span>select employeeid  from nianjiayuangongxinxibiaozb<span class="token punctuation">)</span> and UserID not <span class="token keyword">in</span> <span class="token punctuation">(</span>select userID from UsersInfo where DeleteFlag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> and userID not <span class="token keyword">in</span><span class="token punctuation">(</span><span class="token string">&#39;12754&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;150007&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;12639&#39;</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span>

<span class="token operator">--</span>select gh  from Users where UserID<span class="token operator">=</span><span class="token string">&#39;12768&#39;</span>

set <span class="token decorator"><span class="token at operator">@</span><span class="token function">employeeid</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select gh  from Users where UserID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">UserID</span></span><span class="token punctuation">)</span>
<span class="token operator">--</span>select <span class="token decorator"><span class="token at operator">@</span><span class="token function">employeeid</span></span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">employeename</span></span> <span class="token operator">=</span><span class="token punctuation">(</span>select UserName  from Users where UserID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">UserID</span></span><span class="token punctuation">)</span>
<span class="token operator">--</span>select  <span class="token decorator"><span class="token at operator">@</span><span class="token function">employeename</span></span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">kq</span></span><span class="token operator">=</span><span class="token string">&#39;是&#39;</span>
<span class="token operator">--</span>设置公司
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">gs</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select gs from #kaoqinqintongbulinshi where <span class="token decorator"><span class="token at operator">@</span><span class="token function">UserID</span></span><span class="token operator">=</span>userid <span class="token punctuation">)</span> 

set <span class="token decorator"><span class="token at operator">@</span><span class="token function">MainID</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select <span class="token string">&#39;KQX&#39;</span><span class="token operator">+</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">right</span><span class="token punctuation">(</span>MainID<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">10000001</span> <span class="token keyword">as</span> varchar<span class="token punctuation">)</span>  from nianjiayuangongxinxibiaozb<span class="token punctuation">)</span>

<span class="token operator">--</span>select <span class="token constant">CONVERT</span><span class="token punctuation">(</span><span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">GETDATE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">MainID</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">employeename</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">employeeid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gs</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">kq</span></span>

<span class="token operator">--</span>插入新入职员工信息


select <span class="token decorator"><span class="token at operator">@</span><span class="token function">MainID</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">employeename</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">employeeid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gs</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">kq</span></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">UserID</span></span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>


<span class="token operator">--</span>select <span class="token operator">*</span> from nianjiayuangongxinxibiaozb

begin

<span class="token constant">INSERT</span> <span class="token constant">INTO</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>nianjiayuangongxinxibiaozb<span class="token punctuation">]</span>
           <span class="token punctuation">(</span><span class="token punctuation">[</span>time<span class="token punctuation">]</span>
           <span class="token punctuation">,</span><span class="token punctuation">[</span>swork<span class="token punctuation">]</span>
           <span class="token punctuation">,</span><span class="token punctuation">[</span>MainID<span class="token punctuation">]</span>
           <span class="token punctuation">,</span><span class="token punctuation">[</span>employeename<span class="token punctuation">]</span>
           <span class="token punctuation">,</span><span class="token punctuation">[</span>employeeid<span class="token punctuation">]</span>
           <span class="token punctuation">,</span><span class="token punctuation">[</span>公司<span class="token punctuation">]</span>
           <span class="token punctuation">,</span><span class="token punctuation">[</span>是否考勤<span class="token punctuation">]</span>
           <span class="token punctuation">,</span><span class="token punctuation">[</span>是否离职<span class="token punctuation">]</span><span class="token punctuation">)</span>
     <span class="token constant">VALUES</span> <span class="token punctuation">(</span> <span class="token constant">CONVERT</span><span class="token punctuation">(</span><span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">GETDATE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">MainID</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">employeename</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">employeeid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">gs</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">kq</span></span><span class="token punctuation">,</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
	 end
<span class="token comment">/*
set @i=@i+1

END
*/</span>
<span class="token operator">--</span>设置离职员工考勤未否

<span class="token operator">--</span>设置员工未离职

<span class="token comment">/*暂时放弃
select * from nianjiayuangongxinxibiaozb a
left join  Users b on   a.employeeid=b.gh 
left join vw_Users c on b.UserID=c.UserID and a.employeename=c.UserName
where  a.是否离职=&#39;&#39; and c.DeleteFlag=1 and b.kq=1 

select * from vw_Users  where DeleteFlag = 1 and 

*/</span>
<span class="token operator">--</span>修改员工是否考勤



<span class="token operator">--</span>删除临时表
<span class="token constant">DROP</span> <span class="token constant">TABLE</span>  #kaoqinqintongbulinshi


<span class="token operator">--</span>select <span class="token operator">*</span> from #kaoqinqintongbulinshi where userid<span class="token operator">=</span><span class="token string">&#39;12768&#39;</span>
<span class="token operator">--</span>select <span class="token operator">*</span> from  nianjiayuangongxinxibiaozb where employeeid<span class="token operator">=</span><span class="token string">&#39;12768&#39;</span>

</code></pre></div><h3 id="bi分析" tabindex="-1"><a class="header-anchor" href="#bi分析" aria-hidden="true">#</a> BI分析</h3><p>dataease 流程汇总表更新</p><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>
</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>exec 流程
<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[流程]    Script Date: 2022/11/14 10:11:02 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
  <span class="token constant">ALTER</span>  <span class="token constant">PROCEDURE</span>  <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>流程<span class="token punctuation">]</span> <span class="token keyword">as</span>
  drop table 流程汇总表
  select <span class="token operator">*</span> into 流程汇总表  from  流程汇总试图  <span class="token operator">--</span>old
 <span class="token operator">--</span>select <span class="token operator">*</span>  from  流程汇总表
 update 流程汇总表 <span class="token keyword">set</span> App_Flag<span class="token operator">=</span><span class="token string">&#39;已结束&#39;</span>  where App_Flag<span class="token operator">=</span><span class="token string">&#39;1&#39;</span> 
 update 流程汇总表 <span class="token keyword">set</span> App_Flag<span class="token operator">=</span><span class="token string">&#39;未结束&#39;</span>  where App_Flag<span class="token operator">=</span><span class="token string">&#39;2&#39;</span> 
  <span class="token operator">--</span> 删除的流程计入结束
 update 流程汇总表 <span class="token keyword">set</span> App_Flag<span class="token operator">=</span><span class="token string">&#39;已结束&#39;</span>  where DelFlag<span class="token operator">=</span><span class="token string">&#39;1&#39;</span>
 update 流程汇总表 <span class="token keyword">set</span> DelFlag<span class="token operator">=</span><span class="token string">&#39;删除&#39;</span>  where DelFlag<span class="token operator">=</span><span class="token string">&#39;1&#39;</span>
 update 流程汇总表 <span class="token keyword">set</span> DelFlag<span class="token operator">=</span><span class="token string">&#39;正常&#39;</span>  where DelFlag<span class="token operator">=</span><span class="token string">&#39;0&#39;</span>

 <span class="token operator">--</span>在开始步骤的设置为一结束
 update 流程汇总表 <span class="token keyword">set</span> App_Flag<span class="token operator">=</span><span class="token string">&#39;已结束&#39;</span>  where AppD_Name<span class="token operator">=</span><span class="token string">&#39;开始&#39;</span>
</code></pre></div><h3 id="结束流程" tabindex="-1"><a class="header-anchor" href="#结束流程" aria-hidden="true">#</a> 结束流程</h3><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code><span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[结束流程]    Script Date: 2022/11/14 10:11:18 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>

<span class="token constant">ALTER</span>  <span class="token constant">PROCEDURE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>结束流程<span class="token punctuation">]</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span> <span class="token constant">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">as</span>
<span class="token operator">--</span><span class="token number">2021</span>年<span class="token number">8</span>月<span class="token number">2</span>日更新
<span class="token constant">DECLARE</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Instance_ID</span></span> <span class="token constant">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token operator">--</span>set  <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token operator">=</span><span class="token string">&#39;JHC00078949&#39;</span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">Instance_ID</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select Instance_ID from jhoa_approve  where  AppO_Values<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span>  group by  AppO_Values<span class="token punctuation">,</span>Instance_ID<span class="token punctuation">)</span>
<span class="token operator">--</span>Status<span class="token operator">=</span>completed 状态执行语句   running
<span class="token keyword">if</span> <span class="token constant">EXISTS</span><span class="token punctuation">(</span>select Status from JHOA_Approve_Instance   <span class="token constant">WHERE</span> Instance_ID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Instance_ID</span></span> and  Status<span class="token operator">=</span><span class="token string">&#39;running&#39;</span><span class="token punctuation">)</span>
<span class="token operator">--</span>begin 可以一次执行多个update语句<span class="token punctuation">,</span>下次不在执行
begin
<span class="token constant">UPDATE</span> JHOA_Approve_Instance <span class="token constant">SET</span> Status<span class="token operator">=</span><span class="token string">&#39;completed&#39;</span>  <span class="token constant">WHERE</span> Instance_ID<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Instance_ID</span></span>

<span class="token operator">--</span>app_state<span class="token operator">=</span><span class="token number">0</span>  表示结束 <span class="token number">1</span>表示审批中
update jhoa_approve <span class="token keyword">set</span> app_state<span class="token operator">=</span><span class="token number">0</span> where app_id<span class="token operator">=</span><span class="token punctuation">(</span>select <span class="token function">max</span><span class="token punctuation">(</span>app_id<span class="token punctuation">)</span> from jhoa_approve where appo_values<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token punctuation">)</span>
<span class="token operator">--</span>流程结束值app_state<span class="token operator">=</span><span class="token number">0</span>      未结束app_over<span class="token operator">=</span><span class="token number">1</span>
update jhoa_approve <span class="token keyword">set</span> app_over<span class="token operator">=</span><span class="token number">1</span> where appo_values<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span>
<span class="token operator">--</span>流程结束值 app_flag 审批结束标记<span class="token operator">:</span><span class="token number">2</span>，正在审批；<span class="token number">1</span>审批结束通过；<span class="token number">0</span>审批结束不通过；
update moduleapproveflag <span class="token keyword">set</span> app_flag<span class="token operator">=</span><span class="token number">1</span> where id<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span>
end
</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code> exec matprocanchuangbiaoge 流程弹窗双击弹窗
</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>考勤视图转表
exec <span class="token punctuation">[</span>MiddleData<span class="token punctuation">]</span><span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>TongBuDaomiddleKu
exec 对接外出单同步
exec 华业对接外出单同步
exec <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>考勤视图转表<span class="token punctuation">]</span>
</code></pre></div><h3 id="简石合同序号插入" tabindex="-1"><a class="header-anchor" href="#简石合同序号插入" aria-hidden="true">#</a> 简石合同序号插入</h3><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>
<span class="token constant">INSERT</span> <span class="token constant">INTO</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>jianshi_bianhao<span class="token punctuation">]</span>
<span class="token punctuation">(</span>id<span class="token punctuation">,</span>type<span class="token punctuation">,</span>year<span class="token punctuation">,</span>company<span class="token punctuation">)</span>

select  <span class="token string">&#39;000&#39;</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> t2<span class="token punctuation">.</span>a1 <span class="token keyword">as</span> type <span class="token punctuation">,</span> <span class="token function">year</span><span class="token punctuation">(</span><span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">as</span> year<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>a1 <span class="token keyword">as</span> company   from 简石合同序号查询 t1 
left join 简石合同序号查询 t2  on <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span>
where t1<span class="token punctuation">.</span>a2<span class="token operator">=</span><span class="token number">2</span> and t2<span class="token punctuation">.</span>a2<span class="token operator">=</span><span class="token number">1</span> 
update jianshi_bianhao  <span class="token keyword">set</span> mainid<span class="token operator">=</span> <span class="token string">&#39;JBA0000000000&#39;</span><span class="token operator">+</span><span class="token constant">CONVERT</span><span class="token punctuation">(</span><span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>zid<span class="token punctuation">)</span>
</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>简石<span class="token operator">-</span>合同寻呼提醒作业
exec <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>pt_QDJSMessage<span class="token punctuation">]</span>

<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[pt_QDJSMessage]    Script Date: 2022/11/14 10:13:02 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>


<span class="token constant">ALTER</span> <span class="token constant">PROCEDURE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>pt_QDJSMessage<span class="token punctuation">]</span>  

<span class="token constant">AS</span>
<span class="token constant">BEGIN</span>

<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">remindpeople</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">content</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">djsn</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">djname</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">djsn</span></span><span class="token operator">=</span><span class="token string">&#39;qdjshtsp2019_703c27d9-7015-47b1-bbc8-a55dde3726d2&#39;</span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">djname</span></span><span class="token operator">=</span><span class="token string">&#39;启迪简石合同审批2019&#39;</span>
		<span class="token constant">DECLARE</span> <span class="token constant">H_SETTLE</span> <span class="token constant">SCROLL</span> <span class="token constant">CURSOR</span> <span class="token constant">FOR</span> select mainid<span class="token punctuation">,</span>remindpeople<span class="token punctuation">,</span>content from qidijianshihetongshenpizd where mainid <span class="token keyword">in</span> <span class="token punctuation">(</span>select distinct b<span class="token punctuation">.</span>AppO_Values from jhoa_approve_instance a inner join jhoa_approve b on a<span class="token punctuation">.</span>Instance_ID<span class="token operator">=</span>b<span class="token punctuation">.</span>Instance_ID where Template_ID<span class="token operator">=</span><span class="token string">&#39;2d82a6bb63a54a10b56c7c0a84ef03c3&#39;</span> and Status<span class="token operator">=</span><span class="token string">&#39;completed&#39;</span><span class="token punctuation">)</span> and <span class="token function">dateDiff</span><span class="token punctuation">(</span>dd<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span> and <span class="token function">dateDiff</span><span class="token punctuation">(</span>dd<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">3</span>

		<span class="token constant">OPEN</span> <span class="token constant">H_SETTLE</span>       <span class="token operator">--</span>打开游标
		<span class="token constant">FETCH</span> <span class="token constant">FIRST</span> <span class="token constant">FROM</span> <span class="token constant">H_SETTLE</span> <span class="token constant">INTO</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">remindpeople</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">content</span></span>  <span class="token operator">--</span>游标移到第一个记录
		<span class="token constant">WHILE</span> <span class="token punctuation">(</span>@@<span class="token constant">FETCH_STATUS</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token operator">--</span>检查游标是不是最后一个，如果不是则进行中间的程序
			   <span class="token constant">BEGIN</span>

					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">strXMLList</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>   <span class="token operator">--</span><span class="token operator">-</span>寻呼接受人列表  参考格式：<span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> encoding<span class="token operator">=</span><span class="token string">&quot;gb2312&quot;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>root<span class="token operator">&gt;</span><span class="token operator">&lt;</span>record<span class="token operator">&gt;</span><span class="token operator">&lt;</span>CallToUser<span class="token operator">&gt;</span><span class="token number">0050</span><span class="token operator">&lt;</span><span class="token operator">/</span>CallToUser<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>record<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>root<span class="token operator">&gt;</span>
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSlaveXml</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>  <span class="token operator">--</span><span class="token operator">-</span>弹出寻呼窗口的人  参考格式：<span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> encoding<span class="token operator">=</span><span class="token string">&quot;gb2312&quot;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>root<span class="token operator">&gt;</span><span class="token operator">&lt;</span>record<span class="token operator">&gt;</span><span class="token operator">&lt;</span>UserID<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token constant">CDATA</span><span class="token punctuation">[</span><span class="token number">0050</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>UserID<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>record<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>root<span class="token operator">&gt;</span>
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>    <span class="token operator">--</span><span class="token operator">-</span>寻呼发送者
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">strCallContent</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>  <span class="token operator">--</span><span class="token operator">-</span>寻呼内容
					<span class="token keyword">declare</span>	<span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span> int
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">p5</span></span> int
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span><span class="token operator">=</span><span class="token constant">NULL</span>
					
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select top <span class="token number">1</span> userid from users where username<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">remindpeople</span></span><span class="token punctuation">)</span>
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">app_id</span></span> int<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">AppT_ID</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">url</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>
					select top <span class="token number">1</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">app_id</span></span><span class="token operator">=</span>app_id<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">AppT_ID</span></span><span class="token operator">=</span>appt_id from jhoa_approve where appo_values<span class="token operator">=</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span> order by app_id desc
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">url</span></span><span class="token operator">=</span><span class="token string">&#39;../Jhsoft.Web.module/fceform/common/djframe.htm?djsn=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">djsn</span></span><span class="token operator">+</span><span class="token string">&#39;&amp;djtype=TT&amp;DjName=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">djname</span></span>
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">url</span></span><span class="token operator">+=</span> <span class="token string">&#39;&amp;opentype=2&amp;ModuleID=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">djsn</span></span><span class="token operator">+</span><span class="token string">&#39;&amp;IsNew=1&amp;OperatorTypeWFHsh=FS&amp;httpAppID=&#39;</span><span class="token operator">+</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">app_id</span></span> <span class="token keyword">as</span> varchar<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&#39;&amp;httpOID=0&amp;paravalue=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token operator">+</span><span class="token string">&#39;&amp;_FlowTemplateID=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">AppT_ID</span></span>
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">strCallContent</span></span><span class="token operator">=</span><span class="token string">&#39;&lt;a href = &#39;</span><span class="token string">&#39;&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">url</span></span><span class="token operator">+</span><span class="token string">&#39;&#39;</span><span class="token string">&#39;&gt;&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">content</span></span><span class="token operator">+</span><span class="token string">&#39;&lt;/a&gt;&#39;</span>
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token operator">=</span><span class="token constant">DB_NAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					
					exec pt_CreateID <span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">tbName</span></span><span class="token operator">=</span><span class="token string">&#39;Call&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intOutput</span></span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strID</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span> output
					select <span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span>
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">strXMLList</span></span><span class="token operator">=</span><span class="token string">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;gb2312&quot;?&gt;&lt;root&gt;&lt;record&gt;&lt;CallToUser&gt;&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span><span class="token operator">+</span><span class="token string">&#39;&lt;/CallToUser&gt;&lt;/record&gt;&lt;/root&gt;&#39;</span>
					set  <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSlaveXml</span></span><span class="token operator">=</span><span class="token string">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;gb2312&quot;?&gt;&lt;root&gt;&lt;record&gt;&lt;UserID&gt;&lt;![CDATA[&#39;</span><span class="token operator">+</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span>  <span class="token operator">+</span><span class="token string">&#39;]]&gt;&lt;/UserID&gt;&lt;/record&gt;&lt;/root&gt;&#39;</span>
					exec   pt_CallInsert  <span class="token decorator"><span class="token at operator">@</span><span class="token function">strXMLList</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strXMLList</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intCallID</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intFatherID</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strCallContent</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strCallContent</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSenderDepart</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSmsSign</span></span><span class="token operator">=</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSmsTel</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strFileID</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strModuleID</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strMessageID</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSlaveXml</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span>
					exec pt_CreateID <span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">tbName</span></span><span class="token operator">=</span><span class="token string">&#39;CallTemp&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intOutput</span></span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strID</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p5</span></span> output
					select <span class="token decorator"><span class="token at operator">@</span><span class="token function">p5</span></span>
					exec pt_SendMessage <span class="token decorator"><span class="token at operator">@</span><span class="token function">strXML</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSlaveXml</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">messageType</span></span><span class="token operator">=</span><span class="token string">&#39;Call&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">CallContent</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intbegincallid</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p5</span></span>

			   <span class="token constant">FETCH</span> <span class="token constant">NEXT</span>   <span class="token constant">FROM</span> <span class="token constant">H_SETTLE</span> <span class="token constant">INTO</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">remindpeople</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">content</span></span>    <span class="token operator">--</span>游标移到下一个记录
			   <span class="token constant">END</span>
		 <span class="token constant">CLOSE</span> <span class="token constant">H_SETTLE</span>        <span class="token operator">--</span>关闭游标
		 <span class="token constant">DEALLOCATE</span> <span class="token constant">H_SETTLE</span>        <span class="token operator">--</span>释放游标

<span class="token constant">END</span>


</code></pre></div><h3 id="简石寻呼" tabindex="-1"><a class="header-anchor" href="#简石寻呼" aria-hidden="true">#</a> 简石寻呼</h3><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>
<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[pt_QDJSMessage_l]    Script Date: 2022/11/14 10:13:12 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>

<span class="token constant">ALTER</span> <span class="token constant">PROCEDURE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>pt_QDJSMessage_l<span class="token punctuation">]</span> 
 <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span>  <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
 <span class="token decorator"><span class="token at operator">@</span><span class="token function">remindpeople</span></span>  <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token punctuation">,</span><span class="token operator">--</span>发送者
 <span class="token decorator"><span class="token at operator">@</span><span class="token function">content</span></span>  <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">-</span>寻呼内容
<span class="token constant">AS</span>

<span class="token constant">BEGIN</span>
<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">djsn</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">djname</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">djsn</span></span><span class="token operator">=</span><span class="token string">&#39;qdjshtsp2019_703c27d9-7015-47b1-bbc8-a55dde3726d2&#39;</span>
set <span class="token decorator"><span class="token at operator">@</span><span class="token function">djname</span></span><span class="token operator">=</span><span class="token string">&#39;启迪简石合同审批2019&#39;</span>
		<span class="token constant">DECLARE</span> <span class="token constant">H_SETTLE</span> <span class="token constant">SCROLL</span> <span class="token constant">CURSOR</span> <span class="token constant">FOR</span> select mainid<span class="token punctuation">,</span>remindpeople<span class="token punctuation">,</span>content from qidijianshihetongshenpizd where mainid <span class="token keyword">in</span> <span class="token punctuation">(</span>select distinct b<span class="token punctuation">.</span>AppO_Values from jhoa_approve_instance a inner join jhoa_approve b on a<span class="token punctuation">.</span>Instance_ID<span class="token operator">=</span>b<span class="token punctuation">.</span>Instance_ID where Template_ID<span class="token operator">=</span><span class="token string">&#39;2d82a6bb63a54a10b56c7c0a84ef03c3&#39;</span> and Status<span class="token operator">=</span><span class="token string">&#39;completed&#39;</span><span class="token punctuation">)</span> and <span class="token function">dateDiff</span><span class="token punctuation">(</span>dd<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span> and <span class="token function">dateDiff</span><span class="token punctuation">(</span>dd<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token function">getdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">3</span>


					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">strXMLList</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>   <span class="token operator">--</span><span class="token operator">-</span>寻呼接受人列表  参考格式：<span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> encoding<span class="token operator">=</span><span class="token string">&quot;gb2312&quot;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>root<span class="token operator">&gt;</span><span class="token operator">&lt;</span>record<span class="token operator">&gt;</span><span class="token operator">&lt;</span>CallToUser<span class="token operator">&gt;</span><span class="token number">0050</span><span class="token operator">&lt;</span><span class="token operator">/</span>CallToUser<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>record<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>root<span class="token operator">&gt;</span>
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSlaveXml</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>  <span class="token operator">--</span><span class="token operator">-</span>弹出寻呼窗口的人  参考格式：<span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> encoding<span class="token operator">=</span><span class="token string">&quot;gb2312&quot;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>root<span class="token operator">&gt;</span><span class="token operator">&lt;</span>record<span class="token operator">&gt;</span><span class="token operator">&lt;</span>UserID<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token constant">CDATA</span><span class="token punctuation">[</span><span class="token number">0050</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>UserID<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>record<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>root<span class="token operator">&gt;</span>
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>    <span class="token operator">--</span><span class="token operator">-</span>寻呼发送者
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">strCallContent</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>  <span class="token operator">--</span><span class="token operator">-</span>寻呼内容
					<span class="token keyword">declare</span>	<span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span> int
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">p5</span></span> int
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span><span class="token operator">=</span><span class="token constant">NULL</span>
					
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span><span class="token operator">=</span><span class="token punctuation">(</span>select top <span class="token number">1</span> userid from users where username<span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">remindpeople</span></span><span class="token punctuation">)</span>
					<span class="token keyword">declare</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">app_id</span></span> int<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">AppT_ID</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">url</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>
					select top <span class="token number">1</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">app_id</span></span><span class="token operator">=</span>app_id<span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">AppT_ID</span></span><span class="token operator">=</span>appt_id from jhoa_approve where appo_values<span class="token operator">=</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span> order by app_id desc
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">url</span></span><span class="token operator">=</span><span class="token string">&#39;../Jhsoft.Web.module/fceform/common/djframe.htm?djsn=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">djsn</span></span><span class="token operator">+</span><span class="token string">&#39;&amp;djtype=TT&amp;DjName=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">djname</span></span>
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">url</span></span><span class="token operator">+=</span> <span class="token string">&#39;&amp;opentype=2&amp;ModuleID=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">djsn</span></span><span class="token operator">+</span><span class="token string">&#39;&amp;IsNew=1&amp;OperatorTypeWFHsh=FS&amp;httpAppID=&#39;</span><span class="token operator">+</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">app_id</span></span> <span class="token keyword">as</span> varchar<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&#39;&amp;httpOID=0&amp;paravalue=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">mainid</span></span><span class="token operator">+</span><span class="token string">&#39;&amp;_FlowTemplateID=&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">AppT_ID</span></span>
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">strCallContent</span></span><span class="token operator">=</span><span class="token string">&#39;&lt;a href = &#39;</span><span class="token string">&#39;&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">url</span></span><span class="token operator">+</span><span class="token string">&#39;&#39;</span><span class="token string">&#39;&gt;&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">content</span></span><span class="token operator">+</span><span class="token string">&#39;&lt;/a&gt;&#39;</span>
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token operator">=</span><span class="token constant">DB_NAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					
					exec pt_CreateID <span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">tbName</span></span><span class="token operator">=</span><span class="token string">&#39;Call&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intOutput</span></span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strID</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span> output
					select <span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span>
					set <span class="token decorator"><span class="token at operator">@</span><span class="token function">strXMLList</span></span><span class="token operator">=</span><span class="token string">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;gb2312&quot;?&gt;&lt;root&gt;&lt;record&gt;&lt;CallToUser&gt;&#39;</span><span class="token operator">+</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span><span class="token operator">+</span><span class="token string">&#39;&lt;/CallToUser&gt;&lt;/record&gt;&lt;/root&gt;&#39;</span>
					set  <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSlaveXml</span></span><span class="token operator">=</span><span class="token string">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;gb2312&quot;?&gt;&lt;root&gt;&lt;record&gt;&lt;UserID&gt;&lt;![CDATA[&#39;</span><span class="token operator">+</span>  <span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span>  <span class="token operator">+</span><span class="token string">&#39;]]&gt;&lt;/UserID&gt;&lt;/record&gt;&lt;/root&gt;&#39;</span>
					exec   pt_CallInsert  <span class="token decorator"><span class="token at operator">@</span><span class="token function">strXMLList</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strXMLList</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intCallID</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intFatherID</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strCallContent</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strCallContent</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSender</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSenderDepart</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSmsSign</span></span><span class="token operator">=</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSmsTel</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strFileID</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strModuleID</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strMessageID</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSlaveXml</span></span><span class="token operator">=</span><span class="token string">&#39;&#39;</span>
					exec pt_CreateID <span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">dbName</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">tbName</span></span><span class="token operator">=</span><span class="token string">&#39;CallTemp&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intOutput</span></span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strID</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p5</span></span> output
					select <span class="token decorator"><span class="token at operator">@</span><span class="token function">p5</span></span>
					exec pt_SendMessage <span class="token decorator"><span class="token at operator">@</span><span class="token function">strXML</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">strSlaveXml</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">messageType</span></span><span class="token operator">=</span><span class="token string">&#39;Call&#39;</span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">CallContent</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p4</span></span><span class="token punctuation">,</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">intbegincallid</span></span><span class="token operator">=</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">p5</span></span>
end

</code></pre></div><div class="language-typescript" data-ext="ts"><pre class="language-typescript"><code>合同查询更新
exec hetongchaxunls


<span class="token constant">USE</span> <span class="token punctuation">[</span><span class="token constant">C6</span><span class="token punctuation">]</span>
<span class="token constant">GO</span>
<span class="token doc-comment comment">/****** Object:  StoredProcedure [dbo].[hetongchaxunls]    Script Date: 2022/11/14 10:14:29 ******/</span>
<span class="token constant">SET</span> <span class="token constant">ANSI_NULLS</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">SET</span> <span class="token constant">QUOTED_IDENTIFIER</span> <span class="token constant">ON</span>
<span class="token constant">GO</span>
<span class="token constant">ALTER</span> proc <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>hetongchaxunls<span class="token punctuation">]</span> <span class="token keyword">as</span>
 drop table  hetongchaxunbiao
 select <span class="token operator">*</span> into hetongchaxunbiao<span class="token operator">--</span><span class="token keyword">new</span> 
 <span class="token class-name"><span class="token keyword">from</span></span>  hetongchaxun  <span class="token operator">--</span>old


 <span class="token operator">--</span>更新合同归档
<span class="token operator">--</span> select <span class="token operator">*</span> from hetongchaxunbiao
 update  hetongchaxunbiao <span class="token keyword">set</span> color<span class="token operator">=</span><span class="token string">&#39;待归档&#39;</span>where AppO_Values <span class="token keyword">in</span> <span class="token punctuation">(</span> select MainID from tusenergy129zibiao  where shifouguidang<span class="token operator">=</span><span class="token string">&#39;否&#39;</span><span class="token punctuation">)</span>
</code></pre></div>`,41),e=[o];function c(l,r){return s(),a("div",null,e)}const u=n(p,[["render",c],["__file","oa.html.vue"]]);export{u as default};
